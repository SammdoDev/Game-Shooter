<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Shooter - Banyak Musuh</title>
    <style>
      body {
        text-align: center;
        color: white;
        margin: 0;
      }

      body::-webkit-scrollbar {
        display: none;
      }

      #bgVideo {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1;
      }

      canvas {
        display: block;
        margin: 20px auto;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3); /* Optional: adds a subtle border to see canvas boundaries */
      }

      button {
        position: absolute;
        top: 80%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        border: none;
        font-size: 16px;
        cursor: pointer;
        display: none;
      }

      button:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <video autoplay loop muted playsinline id="bgVideo">
      <source src="Background/canvas_bg.mp4" type="video/mp4" />
    </video>

    <canvas id="gameCanvas" width="1024" height="768"></canvas>
    <button id="restartBtn">Restart</button>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const restartBtn = document.getElementById("restartBtn");

      const playerImage = new Image();
      playerImage.src = "Assets/player.png";

      const enemyImage = new Image();
      enemyImage.src = "Assets/enemy.png";

      const bulletImage = new Image();
      bulletImage.src = "Assets/bullet.png";

      const heartImage = new Image();
      heartImage.src = "Assets/heart.png";

      const shootSound = new Audio("sound/shoot.mp3.");
      const hitSound = new Audio("sound/hit.mp3");

      // Define player dimensions clearly
      const playerWidth = 80; // 2x the size value used for drawing
      const playerHeight = 80; // 2x the size value used for drawing
      const heartSize = 30; // Ukuran gambar hati

      let player = {
        x: canvas.width / 2,
        y: canvas.height - 100,
        size: 40,
        speed: 5,
      };

      let enemies = [];
      let enemyCount = 5;
      let bullets = [];
      let score = 0;
      let highScore = localStorage.getItem("highScore") || 0; // Load high score from localStorage
      let gameOver = false;
      let keys = {};
      let lives = 3; // Nyawa pemain
      let currentWave = 1; // Wave saat ini
      let enemiesKilledInWave = 0; // Jumlah musuh yang dikalahkan dalam wave saat ini
      let enemiesPerWave = 10; // Jumlah musuh yang harus dikalahkan untuk naik wave

      function spawnEnemy() {
        return {
          x: Math.random() * (canvas.width - 200) + 100,
          y: Math.random() * 100,
          size: 60,
          speed: Math.random() * (1 + currentWave * 0.2) + 1, // Kecepatan musuh meningkat dengan wave
        };
      }

      function initializeGame() {
        player = {
          x: canvas.width / 2,
          y: canvas.height - 100,
          size: 40,
          speed: 5,
        };
        enemies = [];
        enemyCount = 5 + currentWave; // Jumlah musuh bertambah setiap wave
        for (let i = 0; i < enemyCount; i++) {
          enemies.push(spawnEnemy());
        }
        bullets = [];
        score = 0;
        lives = 3; // Reset nyawa ke 3 saat restart game
        currentWave = 1; // Reset wave ke 1
        enemiesKilledInWave = 0; // Reset jumlah musuh yang dikalahkan
        gameOver = false;
        restartBtn.style.display = "none";
        update();
      }

      window.addEventListener("keydown", (e) => (keys[e.code] = true));
      window.addEventListener("keyup", (e) => delete keys[e.code]);

      function update() {
        if (gameOver) {
          showGameOver();
          return;
        }

        // Fix player movement boundaries to account for the actual ship size
        if (keys["ArrowLeft"]) {
          // Ensure player doesn't move beyond left edge (accounting for player width)
          player.x = Math.max(playerWidth/2, player.x - player.speed);
        }
        if (keys["ArrowRight"]) {
          // Ensure player doesn't move beyond right edge (accounting for player width)
          player.x = Math.min(canvas.width - playerWidth/2, player.x + player.speed);
        }

        let maxBullets = 5; // Batas maksimal peluru

        function playSound(src) {
          const sound = new Audio(src);
          sound.play();
        }

        if (keys["Space"] && bullets.length < maxBullets) {
          bullets.push({
            x: player.x,
            y: player.y - 20,
            radius: 7,
            speed: 7,
          });

          playSound("shoot.mp3"); // Memainkan suara tembakan tanpa delay
          delete keys["Space"];
        }

        // Fixed enemy-bullet collision detection with proper indexes
        for (let eIndex = enemies.length - 1; eIndex >= 0; eIndex--) {
          const enemy = enemies[eIndex];
          
          for (let bIndex = bullets.length - 1; bIndex >= 0; bIndex--) {
            const bullet = bullets[bIndex];
            
            if (
              bullet.y - bullet.radius < enemy.y + enemy.size &&
              bullet.x > enemy.x - enemy.size &&
              bullet.x < enemy.x + enemy.size
            ) {
              bullets.splice(bIndex, 1);
              enemies.splice(eIndex, 1);
              enemies.push(spawnEnemy());
              score += 1;
              enemiesKilledInWave += 1;
              
              // Check for high score
              if (score > highScore) {
                highScore = score;
                localStorage.setItem("highScore", highScore);
              }
              
              // Check if wave should be increased
              if (enemiesKilledInWave >= enemiesPerWave) {
                currentWave++;
                enemiesKilledInWave = 0;
                
                // Spawn additional enemies for the new wave
                const newEnemies = Math.min(3, currentWave); // Add up to 3 new enemies per wave
                for (let i = 0; i < newEnemies; i++) {
                  enemies.push(spawnEnemy());
                }
              }
              
              playSound("hit.mp3");
              break; // Exit bullet loop after collision
            }
          }
        }

        // Update bullets
        for (let bIndex = bullets.length - 1; bIndex >= 0; bIndex--) {
          const bullet = bullets[bIndex];
          bullet.y -= bullet.speed;
          
          // Remove bullets that go off screen
          if (bullet.y + bullet.radius < 0) {
            bullets.splice(bIndex, 1);
            continue; // Skip to next bullet
          }
        }

        // Update enemies
        enemies.forEach((enemy, index) => {
          enemy.y += enemy.speed;

          if (enemy.y > canvas.height) {
            // Jika musuh melewati layar, reset posisinya tanpa game over
            enemy.x = Math.random() * (canvas.width - 200) + 100;
            enemy.y = Math.random() * 100;
            enemy.speed = Math.random() * (1 + currentWave * 0.2) + 1;
          }

          // Improved collision detection with player
          const enemyLeft = enemy.x - enemy.size/2;
          const enemyRight = enemy.x + enemy.size/2;
          const enemyTop = enemy.y - enemy.size/2;
          const enemyBottom = enemy.y + enemy.size/2;
          
          const playerLeft = player.x - playerWidth/2;
          const playerRight = player.x + playerWidth/2;
          const playerTop = player.y - playerHeight/2;
          const playerBottom = player.y + playerHeight/2;
          
          if (
            enemyRight > playerLeft &&
            enemyLeft < playerRight &&
            enemyBottom > playerTop &&
            enemyTop < playerBottom
          ) {
            lives--; // Kurangi nyawa
            if (lives <= 0) {
              gameOver = true;
              
              // Update high score at game over if needed
              if (score > highScore) {
                highScore = score;
                localStorage.setItem("highScore", highScore);
              }
            } else {
              // Reset posisi musuh
              enemy.x = Math.random() * (canvas.width - 200) + 100;
              enemy.y = Math.random() * 100;
              enemy.speed = Math.random() * (1 + currentWave * 0.2) + 1;
            }
          }
        });

        draw();
        requestAnimationFrame(update);
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw player with correct centering
        ctx.drawImage(
          playerImage,
          player.x - playerWidth/2, // Center horizontally
          player.y - playerHeight/2, // Center vertically
          playerWidth,
          playerHeight
        );

        // Draw hearts above the player
        for (let i = 0; i < lives; i++) {
          ctx.drawImage(
            heartImage,
            player.x - (heartSize * lives) / 2 + i * heartSize,
            player.y - playerHeight/2 - heartSize - 10,
            heartSize,
            heartSize
          );
        }

        enemies.forEach((enemy) => {
          ctx.drawImage(
            enemyImage,
            enemy.x - enemy.size / 2,
            enemy.y - enemy.size / 2,
            enemy.size,
            enemy.size
          );
        });

        bullets.forEach((bullet) => {
          ctx.drawImage(bulletImage, bullet.x - 10, bullet.y - 10, 20, 20);
        });

        // Membuat latar belakang semi-transparan untuk teks di bagian bawah
        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
        ctx.fillRect(0, canvas.height - 50, canvas.width, 50);

        // Game UI display - Semua teks disejajarkan di bagian bawah canvas
        ctx.fillStyle = "white";
        ctx.font = "28px Arial";
        ctx.textAlign = "left";
        ctx.fillText("Game Shooter", 20, canvas.height - 15);
        
        // Score dan high score disejajarkan dengan "Game Shooter" di bagian bawah
        ctx.font = "24px Arial";
        ctx.fillText("Skor: " + score, 220, canvas.height - 15);
        ctx.fillText("Rekor: " + highScore, 350, canvas.height - 15);
        ctx.fillText("Wave: " + currentWave, 520, canvas.height - 15);
        ctx.fillText("Musuh: " + enemiesKilledInWave + "/" + enemiesPerWave, 650, canvas.height - 15);
      }

      function showGameOver() {
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)"; // Semi-transparent background
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "white";
        ctx.font = "48px Arial";
        ctx.textAlign = "center";
        ctx.fillText(
          "Game Over",
          canvas.width / 2,
          canvas.height / 2 - 110
        );
        
        ctx.font = "32px Arial";
        ctx.fillText(
          "Wave Terakhir: " + currentWave,
          canvas.width / 2,
          canvas.height / 2 - 60
        );
        
        ctx.fillText(
          "Skor Akhir: " + score,
          canvas.width / 2,
          canvas.height / 2 - 20
        );
        
        // Display high score in game over screen
        ctx.fillText(
          "Rekor Tertinggi: " + highScore,
          canvas.width / 2,
          canvas.height / 2 + 20
        );
        
        // Display message if new high score achieved
        if (score === highScore && score > 0) {
          ctx.fillStyle = "#FFD700"; // Gold color for high score
          ctx.fillText(
            "Rekor Baru!",
            canvas.width / 2,
            canvas.height / 2 + 60
          );
        }

        restartBtn.style.display = "block";
      }

      restartBtn.addEventListener("click", () => {
        initializeGame();
      });

      // Handle window resize
      window.addEventListener("resize", function() {
        // Optional: Adjust canvas or gameplay based on window size
      });

      // Tunggu hingga semua gambar dimuat sebelum memulai game
      let imagesLoaded = 0;
      const totalImages = 4; // playerImage, enemyImage, bulletImage, heartImage
      
      function imageLoaded() {
        imagesLoaded++;
        if (imagesLoaded === totalImages) {
          initializeGame();
        }
      }
      
      playerImage.onload = imageLoaded;
      enemyImage.onload = imageLoaded;
      bulletImage.onload = imageLoaded;
      heartImage.onload = imageLoaded;
    </script>
  </body>
</html>